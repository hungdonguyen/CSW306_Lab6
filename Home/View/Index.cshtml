@{
 ViewData["Title"] = "Home Page";
}
<!-- Bootstrap5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container mt-5">
 <div class="row p-1">
 <div class="col-1">User:</div>
 <div class="col-5"><input type="text" id="userInput" class="form-control" /></div>
 </div>
 <div class="row p-1">
 <div class="col-1">Message:</div>
 <div class="col-5"><input type="text" id="messageInput" class="form-control" /></div>
 </div>
 <div class="row p-1">
 <div class="col-6 text-end">
 <input type="button" id="sendButton" value="Send Message" class="btn btn-primary" />
 </div>
 </div>
 <div class="row p-1">
 <div class="col-6">
 <hr />
 </div>
 </div>
 <div class="row p-1">
 <div class="col-6">
 <ul id="messagesList" class="list-group"></ul>
 </div>
 </div>
 <div class="row p-1">
 <div class="col-1">Room:</div>
 <div class="col-3">
 <select id="roomSelect" class="form-select">
 <option value="Room1">Room1</option>
 <option value="Room2">Room2</option>
 </select>
 </div>
 <div class="col-2">
 <button id="joinRoomBtn" class="btn btn-success">Join Room</button>
 <button id="leaveRoomBtn" class="btn btn-danger">Leave Room</button>
 </div>
 </div>
 <div class="row p-1">
 <div class="col-1">Send To:</div>
 <div class="col-3">
 <select id="userSelect" class="form-select">
 <option value="">-- Broadcast (All) --</option>
 </select>
 </div>
 </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>

<script>
    var username = prompt("Enter your name:", "User1");
    // 1. Tạo kết nối đến Hub
    var connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub?username=" + username)
        .build();

    // Vô hiệu hóa nút gửi cho đến khi kết nối thành công
    document.getElementById("sendButton").disabled = true;

    // 2. Lắng nghe sự kiện "ReceiveMessage" từ Server
    connection.on("ReceiveMessage", function (user, message) {
        var li = document.createElement("li");
        document.getElementById("messagesList").appendChild(li);
        // Hiển thị tin nhắn: "User says message"
        li.textContent = `${user} says ${message}`;
    });

    connection.on("ReceivePrivateMessage", function (user, message) {
       var li = document.createElement("li");
       li.textContent = `[Private from ${user}]: ${message}`;
       li.style.color = "red";
       document.getElementById("messagesList").appendChild(li);
   });

    // 3. Bắt đầu kết nối
    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
    }).catch(function (err) {
        return console.error(err.toString());
    });

    // 4. Xử lý sự kiện click nút Gửi
    document.getElementById("sendButton").addEventListener("click", function (event) {
        var message = document.getElementById("messageInput").value;
        var receiverId = document.getElementById("userSelect").value;
        if (receiverId) {
               connection.invoke("SendPrivateMessage", receiverId, username, message)
                   .catch(err => console.error(err.toString()));
           } else {
               connection.invoke("SendMessage", username, message)
                   .catch(err => console.error(err.toString()));
           }
           event.preventDefault();
       });

    let currentRoom = null;

    document.getElementById("joinRoomBtn").onclick = function() {
        const room = document.getElementById("roomSelect").value;
        const user = document.getElementById("userInput").value;
        connection.invoke("JoinGroup", room, user);
        currentRoom = room;
    };

    document.getElementById("leaveRoomBtn").onclick = function() {
        const room = currentRoom;
        const user = document.getElementById("userInput").value;
        connection.invoke("LeaveGroup", room, user);
        currentRoom = null;
    };

    document.getElementById("sendButton").onclick = function() {
        const user = document.getElementById("userInput").value;
        const message = document.getElementById("messageInput").value;
        if (currentRoom) {
            connection.invoke("SendGroupMessage", currentRoom, user, message);
        }
    };

    async function loadOnlineUsers() {
       const response = await fetch('/api/chat/users');
       const users = await response.json();
       const userSelect = document.getElementById("userSelect");
       userSelect.innerHTML = '<option value="">-- Broadcast (All) --</option>';
       users.forEach(u => {
           if (u.username !== username) {
               const option = document.createElement("option");
               option.value = u.connectionId;
               option.text = u.username;
               userSelect.appendChild(option);
           }
       });
   }

   loadOnlineUsers();
</script>